<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHIP - Web Host Input Protocol</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.connected {
            background-color: #4ade80;
        }
        .status-indicator.disconnected {
            background-color: #ef4444;
        }
        .status-indicator.connecting {
            background-color: #fbbf24;
        }
        #message-log {
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #f9f9f9;
            font-family: monospace;
            font-size: 12px;
        }
        .message-item {
            margin: 4px 0;
            padding: 4px;
        }
        .message-sent {
            color: #2563eb;
        }
        .message-received {
            color: #059669;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>WHIP Control Interface</h1>
    <p>Web-based remote control for macOS</p>

    <div id="connection-status">
        <p>
            <span class="status-indicator disconnected" id="status-dot"></span>
            Status: <span id="status-text">Connecting...</span>
        </p>
    </div>

    <div>
        <button id="test-btn" disabled>Send Test Message</button>
    </div>

    <h3>Message Log</h3>
    <div id="message-log"></div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const testBtn = document.getElementById('test-btn');
        const messageLog = document.getElementById('message-log');

        function updateStatus(status) {
            statusDot.className = 'status-indicator ' + status;
            switch(status) {
                case 'connected':
                    statusText.textContent = 'Connected';
                    testBtn.disabled = false;
                    break;
                case 'disconnected':
                    statusText.textContent = 'Disconnected';
                    testBtn.disabled = true;
                    break;
                case 'connecting':
                    statusText.textContent = 'Connecting...';
                    testBtn.disabled = true;
                    break;
            }
        }

        function logMessage(direction, message) {
            const item = document.createElement('div');
            item.className = 'message-item message-' + direction;
            const timestamp = new Date().toLocaleTimeString();
            item.textContent = `[${timestamp}] ${direction.toUpperCase()}: ${JSON.stringify(message)}`;
            messageLog.appendChild(item);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function connect() {
            updateStatus('connecting');

            // Construct WebSocket URL based on current page location
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                updateStatus('connected');
                reconnectAttempts = 0;
                logMessage('system', { event: 'connected' });
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                logMessage('received', message);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                logMessage('system', { event: 'error', details: 'Connection error' });
            };

            ws.onclose = function() {
                updateStatus('disconnected');
                logMessage('system', { event: 'closed' });

                // Auto-reconnect with exponential backoff
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                    logMessage('system', { event: 'reconnecting', delay_ms: delay });
                    setTimeout(connect, delay);
                } else {
                    logMessage('system', { event: 'gave_up', reason: 'max_reconnect_attempts_reached' });
                }
            };
        }

        testBtn.addEventListener('click', function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'echo',
                    data: { message: 'Test message from browser' },
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(message));
                logMessage('sent', message);
            }
        });

        // Start connection on page load
        connect();
    </script>
</body>
</html>
