---
phase: 03-macos-control-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/whip/main.py
autonomous: false

must_haves:
  truths:
    - "Server checks Accessibility permissions on startup"
    - "Server displays clear error and instructions if permissions missing"
    - "Background task consumes events from queue"
    - "Mouse cursor moves when receiving mouse_move events"
    - "Mouse clicks trigger when receiving mouse_down/up events"
    - "Keyboard keys press/release when receiving key events"
  artifacts:
    - path: "src/whip/main.py"
      provides: "Permission check at startup, background consumer task"
      contains: "check_accessibility_permission"
  key_links:
    - from: "src/whip/main.py"
      to: "src/whip/permissions.py"
      via: "permission check on startup"
      pattern: "check_accessibility_permission"
    - from: "src/whip/main.py"
      to: "src/whip/controller.py"
      via: "InputController instantiation"
      pattern: "InputController"
    - from: "src/whip/main.py"
      to: "src/whip/queue.py"
      via: "event_queue.get_blocking() in consumer loop"
      pattern: "event_queue\\.get_blocking"
---

<objective>
Integrate permission checking and input controller into the server, wiring the event queue to macOS input control.

Purpose: Complete the Phase 3 goal by connecting browser input events to actual macOS cursor and keyboard control, with proper permission checking on startup.

Output:
- Modified src/whip/main.py with permission check and background consumer
- Working end-to-end input relay: browser -> WebSocket -> queue -> pynput -> macOS
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# From Plan 03-01 (required)
@.planning/phases/03-macos-control-integration/03-01-SUMMARY.md

# Existing code to modify
@src/whip/main.py
@src/whip/protocol.py
@src/whip/queue.py
@src/whip/permissions.py
@src/whip/controller.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission check and event consumer to main.py</name>
  <files>src/whip/main.py</files>
  <action>
Modify src/whip/main.py to integrate permission checking and event consumption:

**1. Add imports at top:**
```python
from whip.permissions import check_accessibility_permission, print_permission_instructions
from whip.controller import InputController
```

**2. Add global controller (after event_queue):**
```python
input_controller: InputController | None = None
```

**3. Create background consumer task:**
```python
async def event_consumer():
    """Background task that drains event queue and controls macOS input."""
    global input_controller
    if input_controller is None:
        return

    while True:
        event = await event_queue.get_blocking(timeout=0.05)
        if event is None:
            continue

        try:
            msg_type = event.get("type")
            data = event.get("data", {})

            if msg_type == MessageType.MOUSE_MOVE:
                input_controller.move_mouse(data.get("x", 0), data.get("y", 0))
            elif msg_type == MessageType.MOUSE_DOWN:
                input_controller.mouse_down(data.get("button", "left"), data.get("x", 0), data.get("y", 0))
            elif msg_type == MessageType.MOUSE_UP:
                input_controller.mouse_up(data.get("button", "left"), data.get("x", 0), data.get("y", 0))
            elif msg_type == MessageType.KEY_DOWN:
                input_controller.key_down(data.get("key", ""), data.get("code", ""))
            elif msg_type == MessageType.KEY_UP:
                input_controller.key_up(data.get("key", ""), data.get("code", ""))
        except Exception as e:
            print(f"[ERROR] Event processing failed: {e}")
```

**4. Modify startup_event to check permissions and start consumer:**
```python
@app.on_event("startup")
async def startup_event():
    global input_controller

    print("WHIP server starting...")
    print("Checking Accessibility permissions...")

    if not check_accessibility_permission():
        print("\n" + "="*60)
        print("ERROR: Accessibility permission NOT granted")
        print("="*60)
        print_permission_instructions()
        print("="*60)
        print("\nServer will start but macOS control will NOT work.")
        print("Grant permission and restart the server.")
        print("="*60 + "\n")
    else:
        print("Accessibility permission: OK")
        input_controller = InputController()
        print(f"Screen size: {input_controller._screen_width}x{input_controller._screen_height}")

        # Start background consumer task
        import asyncio
        asyncio.create_task(event_consumer())
        print("Event consumer started")

    print(f"\nWHIP server running at http://0.0.0.0:9447")
```

**5. Keep existing debug logging in websocket_endpoint** (useful for development)

The consumer reads from event_queue (which WebSocket handler already populates) and translates events to InputController calls. The server starts even without permissions but logs clearly that control won't work.
  </action>
  <verify>
```bash
# Verify imports work
uv run python -c "from whip.main import app; print('main.py OK')"

# Type check
uv run pyright src/whip/main.py

# Start server briefly to check startup message (will need Ctrl+C)
# This is manual verification - server should show permission check result
```
  </verify>
  <done>
- main.py imports permissions and controller modules
- startup_event checks permissions and prints clear status
- If no permission: error message with instructions, server starts but controller is None
- If permission OK: InputController created, consumer task started
- Consumer task processes events from queue via get_blocking()
- Type check passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete macOS control integration</name>
  <what-built>
Complete Phase 3 macOS control integration:
- Permission checking on server startup
- Event queue consumption
- Mouse cursor movement via pynput
- Mouse clicks (left/right/middle)
- Keyboard input relay
  </what-built>
  <how-to-verify>
**If you have NOT granted Accessibility permission yet:**

1. Start the server: `uv run python -m whip`
2. Observe the startup output - should see:
   - "ERROR: Accessibility permission NOT granted"
   - Clear instructions for granting permission
   - Server starts anyway but warns control won't work

3. Grant permission:
   - Open System Settings -> Privacy & Security -> Accessibility
   - Enable Terminal (or your IDE/terminal app)

4. Stop server (Ctrl+C) and restart: `uv run python -m whip`
5. Now should see:
   - "Accessibility permission: OK"
   - Screen size displayed
   - "Event consumer started"

**Test macOS control:**

1. Open browser to http://localhost:9447
2. Verify "Connected" status shown

3. **Mouse movement test:**
   - Move mouse around in the browser canvas
   - Your macOS cursor should follow (matching position)
   - Cursor should reach screen corners when you reach canvas corners

4. **Mouse click test:**
   - Position canvas cursor over something clickable (e.g., Finder icon in dock)
   - Left-click in canvas
   - The click should activate on macOS

5. **Right-click test:**
   - Right-click in canvas
   - Context menu should appear on macOS at that position

6. **Keyboard test:**
   - Click on a text field in another app (e.g., Notes, TextEdit)
   - Return to browser canvas (don't click away, just switch windows)
   - Type on keyboard while canvas is focused
   - Characters should appear in the text field

**Expected behavior:**
- Mouse moves 1:1 with canvas position (approximately - Phase 4 will refine)
- Clicks happen at cursor position
- Keyboard input goes to the frontmost app's focused field
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass.

If issues, describe:
- Which test failed
- What happened vs what was expected
- Any error messages in server console
  </resume-signal>
</task>

</tasks>

<verification>
Phase 3 Success Criteria (from ROADMAP.md):
1. [ ] Server moves macOS cursor when receiving mouse position events
2. [ ] Server triggers mouse clicks (left/right/middle) on host system
3. [ ] Server sends keyboard key press and release events to macOS
4. [ ] Server checks for Accessibility permissions on startup
5. [ ] Server displays clear error message if permissions are missing
6. [ ] User can grant permissions and server works after permission granted

All criteria verified through Task 2 human checkpoint.
</verification>

<success_criteria>
- Server startup shows permission check result
- Clear instructions displayed if permission missing
- With permission: mouse movement works, clicks work, keyboard works
- Phase 3 requirements MACOS-01 through MACOS-06 all satisfied
- User approves checkpoint verification
</success_criteria>

<output>
After completion, create `.planning/phases/03-macos-control-integration/03-02-SUMMARY.md`
</output>
